---
layout: post
title: "NVWatch - Đồng hồ đa dụng"
date: 2025-10-11
tags: [project]
---

## 1. Cài đặt môi trường

### 1.1. Flash Beaglebone black
- Khi mình mới mua về, mình không kết nối được với beagle bone black. Sau một hồi tìm hiểu thì mới nhận ra là do chưa có flash linux.
- Nếu cũng gặp phải tình trạng này, các bạn cần flash theo các bước sau:
    1. Tải image .iso bất kỳ từ trang chủ của [BeagleBone](https://www.beagleboard.org/distros)
    2. Dùng đầu đọc thẻ nhớ, kết nối vào máy tính, rồi chạy lệnh sau để flash
        ```
        sudo dd if=am335x-debian-13-base-v6.16-armhf-2025-09-05-4gb.img of=/dev/sdX bs=1M status=progress conv=fsync
        ```
        Lưu ý: 
        - Thay **am335x-debian-13-base-v6.16-armhf-2025-09-05-4gb.img**thành file image bạn vừa tải về
        - Thay /dev/sdX bằng device của đầu đọc (ví dụ như sda, sdb). Để tìm device đó, dùng lệnh `lsblk` và xem device nào có dung lượng tương đương thẻ nhớ bạn dùng
    3. Tháo thẻ nhớ, nhét vào đầu đọc của Beaglebone, nhấn giữ nút Boot (gần khe cắm thẻ nhớ) rồi nạp nguồn cho BeagleBone, tới khi các LEDs nhấp nháy thì thả nút. Có thể dùng lệnh `lsusb` để kiểm tra đã boot thành công chưa, nếu đã thành công thì sẽ thấy có device `Linux Foundation Multifunction Composite Gadget`

### 1.2. Kết nối BeagleBone với Internet thông qua PC
- Bình thường, beaglebone chỉ tạo kết nối Ethernet với PC qua cổng USB, để kết nối USB Ethernet này với Internet, thực hiện như sau:
    - Trên PC, chạy lệnh `ip a` để tìm network interface với BeagleBone. Ví dụ
        ```
        11: enx182c65031a75: <BROADCAST,MULTICAST,UP,LOWER_UP> mtu 1500 qdisc fq_codel state UP group default qlen 1000
        111
    - Nếu interface đang down, kích hoạt bằng lệnh
        ```
        sudo ip link set enx182c65031a75 up
        ```
    - Share connection bằng lệnh
        ```
        sudo nmcli connection add type ethernet ifname enx182c65031a75 con-name BeagleShare ipv4.method shared  
        sudo nmcli connection up BeagleShare
        ```
    - Sau khi chạy các lệnh trên, ta đã tạo được một DHCP server trên PC, tiếp theo, cần chạy lệnh sau trên Beaglebone để lấy IP từ DHCP server
        ```
        sudo dhclient -v usb0
        ```
    - Tuy nhiên, do BeagleBone chưa có IP nên ta cần kết nối serial để chạy lệnh trên, ở đây mình dùng lệnh `screen` để kết nối
        ```
        sudo screen /dev/ttyACM0 115200
        ```
    - Dùng `ip a` để xem IP

### 1.3. Share màn hình từ Beaglebone lên PC
- Vì trong project này mình có dev UI, nên cần màn hình để test. Nhưng không có màn hình nên mình muốn sử dụng laptop để hiển thị   
- Ở đây mình dùng VNCViewer:
    - Trên BeagleBone, cài và chạy VNC server bằng lệnh sau
        ```
        sudo apt install tightvncserver
        vncserver :1
        ```
    - Trên PC, mình tải RealVNC, rồi connect vào BeagleBone theo địa chỉ \[IP vừa config:5901\]
    
### 1.4. Cài đặt Qt để dev UI
- Trong project này, mình dùng Qt để dev giao diện
- Có 2 cách để dev Qt cho BeagleBone
    1. Cài Qt và QtCreator trên BeagleBone rồi dev như bình thường
    2. Cài Qt trên PC và cross-compile ra binary file để chạy trên BeagleBone
- Ở đây mình dùng cách 2 vì dev Qt trên PC sẽ nhanh hơn, cụ thể
    1. Copy các file của hệ điều hành của Beaglebone qua PC:
        ```
        mkdir -p ~/bbb-sysroot
        rsync -avz --delete debian@<BeagleBone_IP>:/lib ~/bbb-sysroot/
        rsync -avz --delete debian@<BeagleBone_IP>:/usr ~/bbb-sysroot/
        ```
    2. Folder ~/bbb-sysroot sẽ là sys root để cross-compile
    3. Tải source code Qt cho ARM (kiến trúc của BeagleBone)
        ```
        wget https://download.qt.io/archive/qt/5.15/5.15.10/single/qt-everywhere-src-5.15.10.tar.xz
        tar xf qt-everywhere-src-5.15.10.tar.xz
        cd qt-everywhere-src-5.15.10
        ```
    4. Configure và compile (bằng make)
        ```
        ./configure -release -opengl es2 \
        -device linux-beagleboard-g++ \
        -device-option CROSS_COMPILE=/usr/bin/arm-linux-gnueabihf- \
        -sysroot ~/bbb-sysroot \
        -prefix /usr/local/qt5bb \
        -nomake examples -nomake tests
        -no-opengl
        make -j$(nproc)
        make install
        ```